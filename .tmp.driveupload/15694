---
- name: Fetch Juniper inventory from Netbox and save as static inventory
  hosts: localhost
  gather_facts: false
  
  vars:
    netbox_url: "http://192.168.1.102;8000"
    netbox_token: "{{ lookup('env', 'NETBOX_TOKEN') }}"
    inventory_file: "juniper_inventory.yml"
    output_dir: "{{ playbook_dir }}/inventories"
  
  tasks:
    - name: Create inventory directory
      file:
        path: "{{ output_dir }}"
        state: directory
        mode: '0755'
      
    - name: Fetch Juniper devices from Netbox
      uri:
        url: "{{ netbox_url }}/api/dcim/devices/?status=active&manufacturer=juniper"
        method: GET
        headers:
          Authorization: "Token {{ netbox_token }}"
          Accept: "application/json"
        validate_certs: no
        return_content: yes
      register: netbox_devices
      
    - name: Debug received data
      debug:
        msg: "Received {{ netbox_devices.json.results | length }} devices from Netbox"
      when: netbox_devices.json is defined

    - name: Process devices by role
      set_fact:
        routers: "{{ netbox_devices.json.results | selectattr('role.name', 'equalto', 'Juniper Router') | list }}"
        switches: "{{ netbox_devices.json.results | selectattr('role.name', 'equalto', 'Juniper Switch') | list }}"

    - name: Create device dictionaries
      set_fact:
        router_hosts: "{{ routers | map(attribute='name') | list | 
          map('regex_replace', '(.*)', '{\"\\1\": {}}') | map('from_yaml') | list | combine }}"
        switch_hosts: "{{ switches | map(attribute='name') | list |
          map('regex_replace', '(.*)', '{\"\\1\": {}}') | map('from_yaml') | list | combine }}"
        hostvars_dict: "{{ hostvars_temp }}"
      vars:
        hostvars_temp: "{{ {} }}"
        
    - name: Build hostvars for each device
      set_fact:
        hostvars_dict: "{{ hostvars_dict | combine({
          item.name: {
            'ansible_host': item.primary_ip4.address | regex_replace('/.*$', '') if item.primary_ip4 is defined else item.name,
            'device_model': item.device_type.model,
            'site': item.site.name,
            'role': item.role.name,
            'tags': item.tags | map(attribute='name') | list
          }
        }) }}"
      loop: "{{ netbox_devices.json.results }}"

    - name: Create final inventory structure
      set_fact:
        inventory_data:
          all:
            children:
              juniper:
                children:
                  juniper_routers:
                    hosts: "{{ router_hosts }}"
                  juniper_switches:
                    hosts: "{{ switch_hosts }}"
          _meta:
            hostvars: "{{ hostvars_dict }}"

    - name: Save inventory to YAML file
      copy:
        content: "{{ inventory_data | to_nice_yaml }}"
        dest: "{{ output_dir }}/{{ inventory_file }}"
        mode: '0644'
      
    - name: Display inventory file location
      debug:
        msg: 
          - "Inventory file created at: {{ output_dir }}/{{ inventory_file }}"
          - "Number of routers: {{ routers | length }}"
          - "Number of switches: {{ switches | length }}"